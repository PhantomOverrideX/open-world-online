<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OPEN-WORLD ONLINE — Launcher</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #000;
    color: #00ff88;
    font-family: 'Courier New', monospace;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
  }
  #screen {
    width: 480px;
    text-align: center;
  }
  #title {
    font-size: 22px;
    letter-spacing: 6px;
    color: #fff;
    margin-bottom: 6px;
  }
  #subtitle {
    font-size: 11px;
    letter-spacing: 3px;
    color: #555;
    margin-bottom: 40px;
  }
  #status-box {
    border: 1px solid #1a1a1a;
    padding: 24px;
    background: #050505;
    text-align: left;
  }
  .log-line {
    font-size: 12px;
    line-height: 2;
    color: #444;
    transition: color 0.2s;
  }
  .log-line.active  { color: #00ff88; }
  .log-line.done    { color: #336644; }
  .log-line.error   { color: #ff4444; }
  .log-line.warn    { color: #ffaa00; }
  #progress-bar-wrap {
    margin-top: 20px;
    height: 2px;
    background: #111;
    width: 100%;
  }
  #progress-bar {
    height: 100%;
    background: #00ff88;
    width: 0%;
    transition: width 0.3s ease;
  }
  #bottom-msg {
    margin-top: 16px;
    font-size: 11px;
    color: #333;
    letter-spacing: 1px;
    min-height: 18px;
  }
  #tamper-screen {
    display: none;
    border: 1px solid #ff4444;
    padding: 30px;
    background: #0a0000;
  }
  #tamper-screen h2 {
    color: #ff4444;
    font-size: 18px;
    letter-spacing: 4px;
    margin-bottom: 16px;
  }
  #tamper-screen p {
    font-size: 12px;
    color: #aa4444;
    line-height: 1.8;
    margin-bottom: 10px;
  }
  #tamper-screen code {
    color: #ff8888;
    font-size: 11px;
  }
</style>
</head>
<body>
<div id="screen">
  <div id="title">OPEN-WORLD ONLINE</div>
  <div id="subtitle">INTEGRITY LAUNCHER v1.0</div>

  <div id="status-box">
    <div class="log-line" id="l1">[ 1/4 ] Fetching game file...</div>
    <div class="log-line" id="l2">[ 2/4 ] Computing SHA-256 hash...</div>
    <div class="log-line" id="l3">[ 3/4 ] Verifying against server...</div>
    <div class="log-line" id="l4">[ 4/4 ] Launching...</div>
    <div id="progress-bar-wrap"><div id="progress-bar"></div></div>
  </div>

  <div id="tamper-screen">
    <h2>⚠ INTEGRITY CHECK FAILED</h2>
    <p>The game file has been modified and cannot be launched.</p>
    <p>Expected hash does not match the file on disk.</p>
    <p style="margin-top:16px; color:#555;">
      If you are the game owner and made a legitimate update,<br>
      run <code>hash-updater.html</code> to register the new hash.
    </p>
  </div>

  <div id="bottom-msg"></div>
</div>

<script>
// ── CONFIG ────────────────────────────────────────────────────────────────────
// IMPORTANT: Change GAME_FILE to the actual URL or relative path of your game.
// Examples:
//   Same folder:    './OPEN-WORLD_ONLINE.html'
//   GitHub Pages:   '/game/OPEN-WORLD_ONLINE.html'
//   Full URL:       'https://yoursite.com/OPEN-WORLD_ONLINE.html'
const GAME_FILE   = './OPEN-WORLD_ONLINE.html';
const SUPABASE_URL = 'https://jeiweoaqvaldgkgdgzvu.supabase.co';
const SUPABASE_KEY = 'sb_publishable_4_o-75VVd79_BxKj-RZoBQ_A0pV4dkO';
// ─────────────────────────────────────────────────────────────────────────────

const $ = id => document.getElementById(id);

function setLine(id, state, text) {
  const el = $(id);
  el.className = 'log-line ' + state;
  if (text) el.textContent = text;
}

function setProgress(pct) {
  $('progress-bar').style.width = pct + '%';
}

function setBottomMsg(msg, color = '#333') {
  const el = $('bottom-msg');
  el.textContent = msg;
  el.style.color = color;
}

function showTamperScreen() {
  $('status-box').style.display = 'none';
  $('tamper-screen').style.display = 'block';
}

async function sha256(text) {
  const buf = await crypto.subtle.digest(
    'SHA-256',
    new TextEncoder().encode(text)
  );
  return Array.from(new Uint8Array(buf))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
}

async function run() {
  // ── Step 1: Fetch game file ──────────────────────────────────────────────
  setLine('l1', 'active');
  setProgress(5);

  let gameSource;
  try {
    const res = await fetch(GAME_FILE + '?_=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    gameSource = await res.text();
  } catch (e) {
    setLine('l1', 'error', '[ 1/4 ] Failed to fetch game file: ' + e.message);
    setBottomMsg('Make sure both files are on a web server, not opened as local files.', '#ff4444');
    return;
  }

  setLine('l1', 'done', '[ 1/4 ] Game file fetched — ' + (gameSource.length / 1024).toFixed(0) + ' KB');
  setProgress(25);

  // ── Step 2: Compute hash ─────────────────────────────────────────────────
  setLine('l2', 'active');
  // Small delay so the browser can repaint before the blocking hash computation
  await new Promise(r => setTimeout(r, 30));

  const localHash = await sha256(gameSource);

  setLine('l2', 'done', '[ 2/4 ] SHA-256: ' + localHash.slice(0, 16) + '...');
  setProgress(50);

  // ── Step 3: Fetch expected hash from Supabase ────────────────────────────
  setLine('l3', 'active');

  let expectedHash;
  try {
    const res = await fetch(
      SUPABASE_URL + '/rest/v1/game_config?key=eq.game_file_hash&select=value',
      { headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY } }
    );
    const data = await res.json();
    if (!data || !data[0] || !data[0].value) throw new Error('no hash stored');
    expectedHash = data[0].value;
  } catch (e) {
    setLine('l3', 'error', '[ 3/4 ] Could not reach verification server: ' + e.message);
    setBottomMsg('Check your internet connection.', '#ff4444');
    return;
  }

  // First-run: if hash is UNSET, auto-register this as the trusted version
  if (expectedHash === 'UNSET') {
    setLine('l3', 'warn', '[ 3/4 ] No hash registered — this run will set the trusted version.');
    setBottomMsg('First run detected. Registering current file as trusted...', '#ffaa00');
    // Note: storing the hash requires the service role key, so we prompt the owner
    // to run hash-updater.html instead. For now, proceed but warn.
    setProgress(75);
    await launch(gameSource);
    return;
  }

  // ── Compare ──────────────────────────────────────────────────────────────
  if (localHash !== expectedHash) {
    setLine('l3', 'error', '[ 3/4 ] HASH MISMATCH — file has been tampered with');
    console.error('Expected:', expectedHash);
    console.error('Got:     ', localHash);
    showTamperScreen();
    return;
  }

  setLine('l3', 'done', '[ 3/4 ] Hash verified ✓');
  setProgress(75);

  // ── Step 4: Launch ───────────────────────────────────────────────────────
  setLine('l4', 'active');
  setBottomMsg('Integrity confirmed. Launching...', '#00ff88');
  await new Promise(r => setTimeout(r, 400));
  await launch(gameSource);
}

async function launch(gameSource) {
  setLine('l4', 'active', '[ 4/4 ] Launching...');
  setProgress(100);

  // Replace the current page with the game running inside a blob URL.
  // This means the game file URL is never visible in the address bar
  // and the user can't easily navigate to it directly.
  const blob = new Blob([gameSource], { type: 'text/html' });
  const url  = URL.createObjectURL(blob);
  window.location.href = url;
}

run();
</script>
</body>
</html>
