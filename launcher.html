<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- CSP: no inline scripts from external sources, no eval, restricts XSS/extension injection -->
<meta http-equiv="Content-Security-Policy"
  content="default-src 'self' blob: https://jeiweoaqvaldgkgdgzvu.supabase.co;
           script-src 'self' 'unsafe-inline';
           style-src 'unsafe-inline';
           connect-src https://jeiweoaqvaldgkgdgzvu.supabase.co;
           object-src 'none'; base-uri 'self';">
<title>OPEN-WORLD ONLINE — Launcher</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #000;
    color: #00ff88;
    font-family: 'Courier New', monospace;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
  }
  #screen { width: 480px; text-align: center; }
  #title  { font-size: 22px; letter-spacing: 6px; color: #fff; margin-bottom: 6px; }
  #subtitle { font-size: 11px; letter-spacing: 3px; color: #555; margin-bottom: 40px; }
  #status-box {
    border: 1px solid #1a1a1a; padding: 24px;
    background: #050505; text-align: left;
  }
  .log-line { font-size: 12px; line-height: 2; color: #444; transition: color 0.2s; }
  .log-line.active { color: #00ff88; }
  .log-line.done   { color: #336644; }
  .log-line.error  { color: #ff4444; }
  .log-line.warn   { color: #ffaa00; }
  #progress-bar-wrap { margin-top: 20px; height: 2px; background: #111; width: 100%; }
  #progress-bar { height: 100%; background: #00ff88; width: 0%; transition: width 0.3s ease; }
  #bottom-msg { margin-top: 16px; font-size: 11px; color: #333; letter-spacing: 1px; min-height: 18px; }
  #tamper-screen {
    display: none; border: 1px solid #ff4444;
    padding: 30px; background: #0a0000;
  }
  #tamper-screen h2 { color: #ff4444; font-size: 18px; letter-spacing: 4px; margin-bottom: 16px; }
  #tamper-screen p  { font-size: 12px; color: #aa4444; line-height: 1.8; margin-bottom: 10px; }
  #tamper-screen code { color: #ff8888; font-size: 11px; }
</style>
</head>
<body>
<div id="screen">
  <div id="title">OPEN-WORLD ONLINE</div>
  <div id="subtitle">INTEGRITY LAUNCHER v2.0</div>

  <div id="status-box">
    <div class="log-line" id="l1">[ 1/5 ] Fetching game file...</div>
    <div class="log-line" id="l2">[ 2/5 ] Computing SHA-256 hash...</div>
    <div class="log-line" id="l3">[ 3/5 ] Verifying against server...</div>
    <div class="log-line" id="l4">[ 4/5 ] Secondary integrity check...</div>
    <div class="log-line" id="l5">[ 5/5 ] Launching...</div>
    <div id="progress-bar-wrap"><div id="progress-bar"></div></div>
  </div>

  <div id="tamper-screen">
    <h2>⚠ INTEGRITY CHECK FAILED</h2>
    <p>The game file has been modified and cannot be launched.</p>
    <p>Expected hash does not match the file on disk.</p>
    <p style="margin-top:16px; color:#555;">
      If you are the game owner and made a legitimate update,<br>
      run <code>hash-updater.html</code> to register the new hash.
    </p>
  </div>

  <div id="bottom-msg"></div>
</div>

<script>
// Everything is wrapped in a sealed IIFE.
// This means window.sha256, window.launch, window.run etc. do NOT exist —
// there is nothing for a console attacker to override.
(function() {
  'use strict';

  // ── CONFIG ─────────────────────────────────────────────────────────────────
  const GAME_FILE    = './OPEN-WORLD_ONLINE.html';
  const SUPABASE_URL = 'https://jeiweoaqvaldgkgdgzvu.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_4_o-75VVd79_BxKj-RZoBQ_A0pV4dkO';
  // ───────────────────────────────────────────────────────────────────────────

  // Capture critical APIs immediately before any extension/userscript can patch them.
  // Even if crypto.subtle.digest is later overridden, we use the originals here.
  const _digest  = crypto.subtle.digest.bind(crypto.subtle);
  const _fetch   = fetch.bind(window);
  const _encode  = TextEncoder.prototype.encode.bind(new TextEncoder());
  const _Uint8   = Uint8Array;

  const $ = id => document.getElementById(id);

  function setLine(id, state, text) {
    const el = $(id);
    el.className = 'log-line ' + state;
    if(text) el.textContent = text;
  }
  function setProgress(pct) { $('progress-bar').style.width = pct + '%'; }
  function setBottomMsg(msg, color) {
    const el = $('bottom-msg');
    el.textContent = msg;
    el.style.color = color || '#333';
  }
  function showTamperScreen() {
    $('status-box').style.display = 'none';
    $('tamper-screen').style.display = 'block';
  }

  // Uses the captured original digest — immune to crypto.subtle.digest override
  async function sha256(text) {
    const buf = await _digest('SHA-256', _encode(text));
    return Array.from(new _Uint8(buf))
      .map(b => b.toString(16).padStart(2,'0')).join('');
  }

  // Anti-debug: record start time. If a breakpoint was hit between steps, the
  // gap will be abnormally large. We use this as a secondary tamper signal.
  const _startTime = Date.now();

  async function run() {

    // ── Step 1: Fetch game file ──────────────────────────────────────────────
    setLine('l1','active');
    setProgress(5);

    let gameSource;
    try {
      // Cache-bust to prevent serving a cached modified version
      const res = await _fetch(GAME_FILE + '?_=' + Date.now(), { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      gameSource = await res.text();
    } catch(e) {
      setLine('l1','error','[ 1/5 ] Failed to fetch game file: ' + e.message);
      setBottomMsg('Make sure both files are on a web server, not opened as local files.','#ff4444');
      return;
    }

    setLine('l1','done','[ 1/5 ] Game file fetched — ' + (gameSource.length/1024).toFixed(0) + ' KB');
    setProgress(20);

    // ── Step 2: Compute hash (using captured original digest) ────────────────
    setLine('l2','active');
    await new Promise(r => setTimeout(r, 30)); // allow repaint

    const localHash = await sha256(gameSource);

    setLine('l2','done','[ 2/5 ] SHA-256: ' + localHash.slice(0,16) + '...');
    setProgress(40);

    // ── Step 3: Fetch expected hash from Supabase ────────────────────────────
    setLine('l3','active');

    let expectedHash;
    try {
      const res = await _fetch(
        SUPABASE_URL + '/rest/v1/game_config?key=eq.game_file_hash&select=value',
        { headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY } }
      );

      // Validate the HTTP response itself before trusting it
      if(!res.ok) throw new Error('Supabase HTTP ' + res.status);
      const contentType = res.headers.get('content-type') || '';
      if(!contentType.includes('application/json')) throw new Error('unexpected content-type');

      const data = await res.json();

      // Validate response structure — a spoofed response must pass all these checks
      if(!Array.isArray(data))             throw new Error('response not array');
      if(data.length === 0)                throw new Error('no hash stored');
      if(typeof data[0] !== 'object')      throw new Error('bad row format');
      if(typeof data[0].value !== 'string') throw new Error('value not string');
      // A real SHA-256 is always exactly 64 lowercase hex characters
      if(!/^[0-9a-f]{64}$/.test(data[0].value) && data[0].value !== 'UNSET')
        throw new Error('value not valid hash');

      expectedHash = data[0].value;
    } catch(e) {
      setLine('l3','error','[ 3/5 ] Could not reach verification server: ' + e.message);
      setBottomMsg('Check your internet connection.','#ff4444');
      return;
    }

    if(expectedHash === 'UNSET') {
      setLine('l3','warn','[ 3/5 ] No hash registered — run hash-updater.html first.');
      setBottomMsg('Register the trusted hash before launching.','#ffaa00');
      return; // block launch entirely on UNSET — don't let anyone bypass by never setting it
    }

    // Primary comparison
    if(localHash !== expectedHash) {
      setLine('l3','error','[ 3/5 ] HASH MISMATCH — file has been tampered with');
      showTamperScreen();
      return;
    }
    setLine('l3','done','[ 3/5 ] Hash verified ✓');
    setProgress(65);

    // ── Step 4: Secondary integrity check ────────────────────────────────────
    // Re-hash the source a second time independently to catch any MITM that
    // returned the correct hash but served different game content, or any
    // race condition where gameSource was modified between steps.
    // Also checks for abnormal execution time (debugger pause).
    setLine('l4','active');
    await new Promise(r => setTimeout(r, 40));

    const secondHash = await sha256(gameSource);
    if(secondHash !== localHash) {
      setLine('l4','error','[ 4/5 ] Secondary check failed — source modified in memory');
      showTamperScreen();
      return;
    }

    // Warn if execution took far too long (possible breakpoint between steps)
    const elapsed = Date.now() - _startTime;
    if(elapsed > 30000) {
      // Don't block — just note it. Server-side integrity checks matter more.
      setLine('l4','warn','[ 4/5 ] Secondary check ✓ (slow: ' + (elapsed/1000).toFixed(0) + 's — debugger?)');
    } else {
      setLine('l4','done','[ 4/5 ] Secondary check ✓');
    }
    setProgress(85);

    // ── Step 5: Launch ───────────────────────────────────────────────────────
    setLine('l5','active');
    setBottomMsg('Integrity confirmed. Launching...','#00ff88');
    await new Promise(r => setTimeout(r, 400));

    setProgress(100);

    // Launch in blob — gameSource is a local variable in this IIFE closure.
    // There is no window.gameSource to inspect or modify.
    const blob = new Blob([gameSource], { type:'text/html' });
    const url  = URL.createObjectURL(blob);
    window.location.href = url;

    // Null out the source reference immediately so it can't be read
    // from memory via heap snapshot in DevTools
    gameSource = null;
  }

  // Run immediately — no exported globals, nothing to override from console
  run().catch(e => {
    setLine('l5','error','[ 5/5 ] Unexpected error: ' + e.message);
    setBottomMsg('An unexpected error occurred.','#ff4444');
  });

})(); // end sealed IIFE — window.run, window.sha256, window.launch do not exist
</script>
</body>
</html>